<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Produtos</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <div class="bg-radial"></div>

  <div class="container">
    <!-- Header -->
    <header class="header card">
      <div class="header__left">
        <h1 class="title">Dashboard de Produtos</h1>
        <p class="subtitle">Acompanhe seus itens em tempo real</p>
      </div>
      <div class="actions">
        <a href="{{ url_for('carregar') }}" class="btn btn-primary">
          <span class="btn__dot" aria-hidden="true"></span> Carregar
        </a>
        <button class="btn btn-success" onclick="openModal()">
          <span class="btn__plus" aria-hidden="true">+</span> Novo Produto
        </button>
      </div>
    </header>

    <!-- Error Alert -->
    {% if error %}
    <div class="alert card" role="alert">
      <span class="alert__icon" aria-hidden="true">⚠️</span>
      <div>{{ error }}</div>
    </div>
    {% endif %}

    <!-- Stats -->
    <section class="stats">
      <article class="stat card">
        <div class="stat__label">Produtos Únicos</div>
        <div class="stat__value">{{ produtos|map(attribute='produto')|unique|list|length }}</div>
      </article>

      <article class="stat card">
        <div class="stat__label">Categorias</div>
        <div class="stat__value">{{ produtos|map(attribute='categoria')|unique|list|length }}</div>
      </article>

      <article class="stat card">
        <div class="stat__label">Total de Produtos</div>
        <div class="stat__value">{{ produtos|length }}</div>
      </article>
    </section>

    <!-- Products Table -->
    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Produtos Cadastrados</h2>
      </div>
      <div class="card__body">
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Produto</th>
                <th>Qtd</th>
                <th>Categoria</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for item in produtos %}
              <tr>
                <td><strong>#{{ item.id }}</strong></td>
                <td class="truncate">{{ item.produto }}</td>
                <td>{{ item.quantidade }}</td>
                <td><span class="badge">{{ item.categoria }}</span></td>
                <td>
                  <a href="{{ url_for('excluir', id=item.id) }}" class="btn btn-danger btn-icon" onclick="return confirm('Excluir?')"
                     aria-label="Excluir produto #{{ item.id }}">×</a>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted">Nenhum produto encontrado</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Recent Items -->
    {% if produtos %}
    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Últimos 5 Produtos</h2>
      </div>
      <div class="card__body">
        <ul class="recent-items">
          {% for item in produtos[-5:] %}
          <li class="recent-item">
            <div class="recent-item__meta">
              <strong class="truncate">{{ item.produto }}</strong>
              <span class="text-muted"> • {{ item.categoria }}</span>
            </div>
            <div class="quantity-badge" title="Quantidade">{{ item.quantidade }}</div>
          </li>
          {% endfor %}
        </ul>
      </div>
    </section>
    {% endif %}

    <!-- Charts -->
    <section class="charts">
      <article class="card">
        <div class="card__header">
          <h2 class="card__title">Quantidade por Produto</h2>
        </div>
        <div class="card__body">
          <div class="chart-container">
            {% if chart_barras != "Não gerado" %}
              <img src="data:image/png;base64,{{ chart_barras }}" alt="Gráfico de barras - Quantidade por Produto" />
            {% else %}
              <div class="empty-state">
                <p>Gráfico não disponível</p>
              </div>
            {% endif %}
          </div>
        </div>
      </article>

      <article class="card">
        <div class="card__header">
          <h2 class="card__title">Distribuição por Categoria</h2>
        </div>
        <div class="card__body">
          <div class="chart-container">
            {% if chart_pizza != "Não gerado" %}
              <img src="data:image/png;base64,{{ chart_pizza }}" alt="Gráfico de pizza - Distribuição por Categoria" />
            {% else %}
              <div class="empty-state">
                <p>Gráfico não disponível</p>
              </div>
            {% endif %}
          </div>
        </div>
      </article>
    </section>
  </div>

  <!-- Modal -->
  <div class="modal" id="productModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal__overlay" onclick="closeModal()"></div>
    <div class="modal__content card" role="document">
      <div class="modal__header">
        <h2 id="modalTitle" class="modal__title">Novo Produto</h2>
        <button class="close-btn" onclick="closeModal()" aria-label="Fechar modal">×</button>
      </div>
      <form method="POST" action="{{ url_for('adicionar') }}">
        <div class="form-group">
          <label class="form-label" for="produto">Produto</label>
          <input id="produto" type="text" name="produto" class="form-input" required placeholder="Nome do produto" />
        </div>
        <div class="form-group">
          <label class="form-label" for="quantidade">Quantidade</label>
          <input id="quantidade" type="number" name="quantidade" class="form-input" min="1" required placeholder="Quantidade" />
        </div>
        <div class="form-group">
          <label class="form-label" for="categoria">Categoria</label>
          <input id="categoria" type="text" name="categoria" class="form-input" required placeholder="Categoria" />
        </div>
        <div class="form-actions">
          <button type="button" class="btn" onclick="closeModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- FAB (Mobile) -->
  <button class="fab" onclick="openModal()" aria-label="Adicionar novo produto">+</button>

  <script>
    // Modal
    function openModal() {
      const m = document.getElementById('productModal');
      m.classList.add('show');
      document.body.style.overflow = 'hidden';
      setTimeout(() => document.getElementById('produto')?.focus(), 0);
    }
    function closeModal() {
      const m = document.getElementById('productModal');
      m.classList.remove('show');
      document.body.style.overflow = 'auto';
    }
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // Validação simples
    const form = document.querySelector('form');
    form?.addEventListener('submit', function(e) {
      const inputs = this.querySelectorAll('input[required]');
      let ok = true;
      inputs.forEach((i) => {
        if (!i.value.trim()) {
          i.classList.add('invalid');
          ok = false;
        } else {
          i.classList.remove('invalid');
        }
      });
      if (!ok) {
        e.preventDefault();
        alert('Preencha todos os campos obrigatórios.');
      }
    });

    // Loading no botão GCS
    document.querySelector('a[href*="carregar"]')?.addEventListener('click', function() {
      this.classList.add('is-loading');
      this.innerHTML = '<span class="spinner" aria-hidden="true"></span> Carregando...';
    });
  </script>
</body>
</html>
